<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>NotAldim | V71 Active</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        :root { --blue: #0095f6; --bg: #000; --card: #121212; --border: #262626; --red: #ff3b30; --green: #2ecc71; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: white; font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; padding-bottom: 85px; }
        
        .page { display: none; padding: 15px; max-width: 500px; margin: 0 auto; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; } }
        
        .glass-card { background: var(--card); border: 1px solid var(--border); border-radius: 24px; padding: 20px; margin-bottom: 20px; position: relative; }
        
        /* Aktiflik Noktasƒ± */
        .online-dot { width: 12px; height: 12px; background: var(--green); border-radius: 50%; border: 2px solid #000; position: absolute; bottom: 2px; right: 2px; }
        .offline-dot { width: 12px; height: 12px; background: #555; border-radius: 50%; border: 2px solid #000; position: absolute; bottom: 2px; right: 2px; }

        /* Mesaj Listesi */
        .chat-item { display: flex; align-items: center; gap: 15px; padding: 15px; border-radius: 20px; background: #1a1a1a; margin-bottom: 10px; cursor: pointer; position: relative; }
        .chat-img-wrap { position: relative; width: 50px; height: 50px; }
        .chat-img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .unread-count { background: var(--red); color: white; min-width: 20px; height: 20px; border-radius: 10px; font-size: 11px; font-weight: 800; display: flex; align-items: center; justify-content: center; position: absolute; top: 10px; right: 15px; padding: 0 6px; }

        /* Mesaj Balonlarƒ± */
        .msg-bubble { margin-bottom: 10px; padding: 12px 16px; border-radius: 22px; max-width: 80%; font-size: 14px; position: relative; display: flex; flex-direction: column; }
        .msg-me { align-self: flex-end; background: var(--blue); border-bottom-right-radius: 4px; }
        .msg-other { align-self: flex-start; background: #262626; border-bottom-left-radius: 4px; }
        .status-unread { color: #ccc; font-size: 12px; }
        .status-read { color: #00faff; font-weight: bold; font-size: 12px; }

        .nav { position: fixed; bottom: 0; width: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 18px 0; z-index: 1000; }
        .nav-i { font-size: 24px; cursor: pointer; opacity: 0.3; }
        .nav-i.active { opacity: 1; color: var(--blue); }

        .note-card { background: var(--card); border: 1px solid var(--border); border-radius: 24px; padding: 15px; margin-bottom: 25px; }
        .card-img { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; border: 2px solid var(--blue); }
        .s-btn { cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 4px; padding: 8px 12px; border-radius: 12px; background: #1a1a1a; border: 1px solid var(--border); }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="loading" style="position:fixed;inset:0;background:#000;z-index:9999;display:none;align-items:center;justify-content:center;">Y√ºkleniyor...</div>

    <div id="auth-area">
        <div id="login-p" class="page active">
            <div class="glass-card" style="margin-top:100px; text-align:center;">
                <h1>NotAldim</h1>
                <input type="text" id="l-u" placeholder="Kullanƒ±cƒ± Adƒ±" onkeydown="if(event.key==='Enter') login()">
                <input type="password" id="l-p" placeholder="≈ûifre" onkeydown="if(event.key==='Enter') login()">
                <button onclick="login()">Giri≈ü Yap</button>
                <p onclick="goAuth('reg-p')" style="color:var(--blue);cursor:pointer;margin-top:20px;">Kaydol</p>
            </div>
        </div>
        <div id="reg-p" class="page"><div class="glass-card"><h2>Kaydol</h2><input type="text" id="r-u" placeholder="Kullanƒ±cƒ± Adƒ±"><input type="email" id="r-m" placeholder="E-Posta"><input type="password" id="r-p" placeholder="≈ûifre"><button onclick="register()">Hesap Olu≈ütur</button></div></div>
    </div>

    <div id="app" class="hidden">
        <div id="page-home" class="page active"><h2>Akƒ±≈ü</h2><div id="note-list"></div></div>
        
        <div id="page-msg" class="page">
            <h2>Mesajlar</h2>
            <div id="chat-list"></div>
            <div id="chat-box" class="hidden">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;"><span onclick="closeChat()" style="cursor:pointer; font-size:20px;">‚¨Ö</span><h3 id="chat-with-name"></h3></div>
                <div id="chat-messages" style="height:450px; overflow-y:auto; padding:15px; border-radius:24px; background:#080808; display:flex; flex-direction:column; margin-bottom:15px;"></div>
                <div style="display:flex; gap:10px;"><input id="msg-input" placeholder="Mesaj..."><button onclick="sendMsg()" style="width:70px;">‚û§</button></div>
            </div>
        </div>

        <div id="page-noti" class="page"><h2>Bildirimler</h2><div id="noti-list"></div></div>
        <div id="page-admin" class="page"><h2>üõ°Ô∏è Admin</h2><div id="ad-users-list"></div></div>

        <div id="page-prof" class="page">
            <div class="glass-card" style="text-align:center;">
                <div style="position:relative; width:100px; margin:0 auto;">
                    <img id="p-u-img" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:3px solid var(--blue);">
                    <div id="p-status-dot"></div>
                </div>
                <h2 id="p-u-name"></h2>
                <div style="display:flex; justify-content:center; gap:30px; margin:20px 0;">
                    <div><b>Takip√ßi</b><br><span id="p-followers">0</span></div>
                    <div><b>Takip</b><br><span id="p-following">0</span></div>
                </div>
                <div id="my-prof-actions" class="hidden"><button onclick="logout()" style="background:var(--red);">G√ºvenli √áƒ±kƒ±≈ü</button></div>
                <div id="other-prof-actions" class="hidden"><button id="follow-btn" onclick="handleFollowAction()">Takip Et</button><button onclick="openChatFromProf()" style="background:#222; margin-top:10px;">Mesaj G√∂nder</button></div>
            </div>
        </div>

        <div class="nav"><div class="nav-i active" onclick="nav('home', this)">üè†</div><div class="nav-i" onclick="nav('msg', this)">üí¨</div><div id="nav-ad" class="nav-i hidden" onclick="nav('admin', this)">üõ°Ô∏è</div><div class="nav-i" onclick="nav('prof', this, true)">üë§</div></div>
    </div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyAFcxbgumt1FFDqZAYGbYWAaLyplMB6yM4", authDomain: "notsakla-a165c.firebaseapp.com", databaseURL: "https://notsakla-a165c-default-rtdb.firebaseio.com", projectId: "notsakla-a165c", storageBucket: "notsakla-a165c.firebasestorage.app", messagingSenderId: "374348253046", appId: "1:374348253046:web:cb9b66993d80f682911c57" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let cur = null, viewU = null, activeChat = null;

    // AKTƒ∞FLƒ∞K Sƒ∞STEMƒ∞
    function setOnlineStatus(u, status) {
        if(u) db.ref('status/'+u).set({state: status, last: Date.now()});
    }

    window.onload = () => {
        const saved = localStorage.getItem('notUser');
        if(saved) db.ref('users/'+saved).once('value', sn => { if(sn.exists()){ cur = sn.val(); startApp(); } });
    };

    window.onbeforeunload = () => { if(cur) setOnlineStatus(cur.user, 'offline'); };

    function login() {
        const u = document.getElementById('l-u').value.trim().toLowerCase(), p = document.getElementById('l-p').value.trim();
        db.ref('users/'+u).once('value', sn => {
            const d = sn.val();
            if(d && d.pass == p){ cur = d; localStorage.setItem('notUser', u); startApp(); } else alert("Hata!");
        });
    }

    function startApp() {
        document.getElementById('auth-area').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        if(cur.role == 'admin') { document.getElementById('nav-ad').classList.remove('hidden'); }
        setOnlineStatus(cur.user, 'online');
        loadFeed(); loadChatList();
    }

    function loadChatList() {
        db.ref('chats').on('value', sn => {
            const chats = sn.val() || {};
            let h = "";
            const userChats = Object.keys(chats).filter(id => id.includes(cur.user));
            
            userChats.forEach(cid => {
                const other = cid.replace(cur.user, '').replace('_', '');
                db.ref('users/'+other).once('value', usn => {
                    const ud = usn.val();
                    // Okunmamƒ±≈ü mesaj sayƒ±sƒ±nƒ± bul
                    const messages = chats[cid];
                    let unread = 0;
                    Object.values(messages).forEach(m => { if(m.u !== cur.user && !m.seen) unread++; });

                    // Aktiflik durumunu √ßek
                    db.ref('status/'+other).on('value', ssn => {
                        const status = ssn.val()?.state || 'offline';
                        const dotClass = status === 'online' ? 'online-dot' : 'offline-dot';
                        const itemHtml = `
                            <div class="chat-item" onclick="openActiveChat('${other}')">
                                <div class="chat-img-wrap">
                                    <img src="${ud.img}" class="chat-img">
                                    <div class="${dotClass}"></div>
                                </div>
                                <div>
                                    <b>${other}</b><br>
                                    <small style="color:${status==='online'?'var(--green)':'#777'}">${status==='online'?'Aktif':'√áevrimdƒ±≈üƒ±'}</small>
                                </div>
                                ${unread > 0 ? `<div class="unread-count">${unread}</div>` : ''}
                            </div>`;
                        document.getElementById('chat-list').innerHTML += itemHtml;
                    });
                });
            });
            document.getElementById('chat-list').innerHTML = ""; // Clear for refresh
        });
    }

    function openActiveChat(other) {
        activeChat = [cur.user, other].sort().join('_');
        document.getElementById('chat-list').classList.add('hidden');
        document.getElementById('chat-box').classList.remove('hidden');
        document.getElementById('chat-with-name').innerText = other;
        
        db.ref('chats/'+activeChat).on('value', sn => {
            const ms = sn.val() || {}; let h = "";
            Object.keys(ms).forEach(mid => {
                const m = ms[mid]; const isMe = m.u === cur.user;
                if(!isMe && !m.seen) db.ref('chats/'+activeChat+'/'+mid+'/seen').set(true);
                const tƒ±k = isMe ? (m.seen ? '<span class="status-read">‚úì‚úì</span>' : '<span class="status-unread">‚úì</span>') : '';
                h += `<div class="msg-bubble ${isMe?'msg-me':'msg-other'}">
                        ${m.m}
                        <div style="font-size:8px; align-self:flex-end; margin-top:4px;">${tƒ±k} ${m.u}</div>
                      </div>`;
            });
            const b = document.getElementById('chat-messages'); b.innerHTML = h; b.scrollTop = b.scrollHeight;
        });
    }

    function sendMsg() {
        const i = document.getElementById('msg-input'); if(!i.value || !activeChat) return;
        db.ref('chats/'+activeChat).push({u:cur.user, m:i.value, t:Date.now(), seen:false});
        i.value = "";
    }

    // STANDARTLAR
    function loadFeed() {
        db.ref('posts').on('value', sn => {
            const data = sn.val() || {}; let h = "";
            Object.keys(data).reverse().forEach(id => {
                const p = data[id]; const myV = (p.votes && p.votes[cur.user]) ? 'voted' : '';
                h += `<div class="note-card">
                    <div class="card-header" onclick="viewProfile('${p.owner}')"><img src="${p.ownerImg}" class="card-img"><b>${p.owner}</b></div>
                    <p>${p.b}</p>
                    <div class="social-btns">
                        <span class="s-btn" onclick="handleVote('${id}','up')">üëç ${p.up||0}</span>
                        <span class="s-btn" onclick="handleVote('${id}','down')">üëé ${p.down||0}</span>
                    </div>
                </div>`;
            });
            document.getElementById('note-list').innerHTML = h;
        });
    }

    function viewProfile(u) {
        viewU = u; nav('prof', document.querySelector('.nav-i[onclick*="prof"]'));
        db.ref('users/'+u).on('value', sn => {
            const d = sn.val(); if(!d) return;
            document.getElementById('p-u-name').innerText = u;
            document.getElementById('p-u-img').src = d.img;
            db.ref('status/'+u).once('value', ssn => {
                const dot = ssn.val()?.state === 'online' ? 'online-dot' : 'offline-dot';
                document.getElementById('p-status-dot').className = dot;
            });
            document.getElementById('p-followers').innerText = d.followers ? Object.keys(d.followers).length : 0;
            document.getElementById('p-following').innerText = d.following ? Object.keys(d.following).length : 0;
            if(u === cur.user) document.getElementById('my-prof-actions').classList.remove('hidden');
            else { document.getElementById('other-prof-actions').classList.remove('hidden'); }
        });
    }

    function handleVote(pid, type) {
        db.ref('posts/'+pid).transaction(p => {
            if(!p) return p; if(!p.votes) p.votes = {};
            const old = p.votes[cur.user];
            if(old === type) { delete p.votes[cur.user]; p[type] = Math.max(0, (p[type]||1)-1); }
            else { if(old) p[old] = Math.max(0, (p[old]||1)-1); p.votes[cur.user] = type; p[type] = (p[type]||0)+1; }
            return p;
        });
    }

    function nav(id, el, isMy = false) { 
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); 
        document.getElementById('page-'+id).classList.add('active'); 
        document.querySelectorAll('.nav-i').forEach(i => i.classList.remove('active')); 
        el.classList.add('active'); 
        if(isMy) viewProfile(cur.user); 
    }
    function logout() { setOnlineStatus(cur.user, 'offline'); localStorage.removeItem('notUser'); location.reload(); }
    function closeChat() { document.getElementById('chat-box').classList.add('hidden'); document.getElementById('chat-list').classList.remove('hidden'); }
    function openChatFromProf() { nav('msg', document.querySelector('.nav-i[onclick*="msg"]')); openActiveChat(viewU); }
    function register() { const u = document.getElementById('r-u').value.trim().toLowerCase(), m = document.getElementById('r-m').value.trim(), p = document.getElementById('r-p').value.trim(); db.ref('users/'+u).set({user:u, mail:m, pass:p, role:'user', img:'https://cdn-icons-png.flaticon.com/512/149/149071.png'}).then(()=>location.reload()); }
</script>
</body>
</html>

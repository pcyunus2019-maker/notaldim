<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>NotAldim | Aesthetic Vision</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        :root { --blue: #0095f6; --bg: #000; --card: #000; --border: #262626; --red: #ff3040; --grad: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: white; font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; padding-bottom: 75px; overflow-x: hidden; }
        
        .page { display: none; width: 100%; max-width: 500px; margin: 0 auto; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Resimdeki Gibi Header */
        .insta-header { height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid #1a1a1a; position: sticky; top: 0; background: #000; z-index: 100; }
        .insta-header h1 { font-size: 22px; font-weight: 800; }

        /* Story Design (Kar≈üƒ±lƒ±klƒ± Takip ≈ûartlƒ±) */
        .story-bar { display: flex; gap: 15px; overflow-x: auto; padding: 15px; scrollbar-width: none; border-bottom: 1px solid #1a1a1a; }
        .story-ring { width: 72px; height: 72px; border-radius: 50%; background: var(--grad); padding: 3px; cursor: pointer; }
        .story-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid #000; }

        /* Liste Tasarƒ±mƒ± (Mesaj & √úyeler) */
        .list-item { display: flex; align-items: center; gap: 15px; padding: 12px 15px; cursor: pointer; transition: 0.2s; }
        .list-item:active { background: #121212; }
        .list-img { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; }
        .list-info { flex: 1; border-bottom: 0.5px solid #1a1a1a; padding-bottom: 12px; }
        .list-name { font-weight: 700; font-size: 15px; }
        .list-sub { font-size: 13px; color: #8e8e8e; margin-top: 2px; }

        /* Admin Full Men√º */
        .adm-card { background: #121212; border-radius: 20px; padding: 20px; margin: 15px; text-align: center; border: 1px solid var(--border); }
        .adm-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .adm-btn { padding: 12px; border-radius: 12px; font-size: 11px; font-weight: 800; border: none; cursor: pointer; color: white; }

        /* Full Screen Story */
        #story-overlay { position: fixed; inset: 0; background: #000; z-index: 2000; display: none; flex-direction: column; }
        .st-top { padding: 15px; display: flex; align-items: center; justify-content: space-between; }
        .st-viewer-list { position: absolute; bottom: 30px; left: 0; width: 100%; text-align: center; font-size: 14px; color: #8e8e8e; cursor: pointer; }

        /* Nav */
        .nav { position: fixed; bottom: 0; width: 100%; height: 60px; background: #000; border-top: 1px solid #1a1a1a; display: flex; justify-content: space-around; align-items: center; z-index: 1000; }
        .nav-i { font-size: 26px; cursor: pointer; opacity: 0.4; }
        .nav-i.active { opacity: 1; }

        .hidden { display: none !important; }
        button { width: 100%; padding: 14px; border-radius: 12px; border: none; background: var(--blue); color: white; font-weight: 800; cursor: pointer; }
        input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--border); background: #121212; color: white; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="story-overlay">
        <div class="st-top">
            <div id="st-user-info" style="display:flex;align-items:center;gap:10px;"></div>
            <span onclick="closeStory()" style="font-size:30px;cursor:pointer;">‚úï</span>
        </div>
        <div style="flex:1; display:flex; align-items:center; justify-content:center; position:relative;">
            <img id="st-img-full" style="max-width:100%; max-height:80vh; border-radius:10px;">
            <div id="st-views" class="st-viewer-list" onclick="showWhoViewed()">0 ki≈üi g√∂rd√º</div>
        </div>
    </div>

    <div class="insta-header">
        <h1 id="header-title">Instagram</h1>
        <div style="display:flex;gap:20px;font-size:22px;">
            <span onclick="nav('noti')">‚ù§Ô∏è</span>
            <span onclick="nav('msg')">üí¨</span>
        </div>
    </div>

    <div id="app">
        <div id="page-home" class="page active">
            <div class="story-bar" id="home-stories"></div>
            <div id="feed-list"></div>
        </div>

        <div id="page-search" class="page">
            <div style="padding:15px;"><input type="text" placeholder="Ara..." oninput="doSearch(this.value)"></div>
            <div id="member-list"></div>
        </div>

        <div id="page-add" class="page">
            <div style="padding:20px;">
                <h2>Payla≈ü</h2>
                <textarea id="post-body" rows="5" placeholder="A√ßƒ±klama..."></textarea>
                <input type="file" id="post-file">
                <button onclick="savePost()">Yayƒ±nla</button>
            </div>
        </div>

        <div id="page-msg" class="page">
            <div id="chat-list"></div>
            <div id="chat-box" class="hidden">
                <div style="padding:15px; border-bottom:1px solid #1a1a1a; display:flex; align-items:center; gap:15px;">
                    <span onclick="closeChat()">‚á†</span> <b id="chat-target-name"></b>
                </div>
                <div id="chat-messages" style="height:70vh; overflow-y:auto; padding:15px;"></div>
                <div style="padding:10px; display:flex; gap:10px;">
                    <input id="msg-input" placeholder="Mesaj..." style="margin:0;">
                    <button onclick="sendMsg()" style="width:60px;">‚û§</button>
                </div>
            </div>
        </div>

        <div id="page-admin" class="page">
            <div id="ad-list"></div>
            <div id="ad-detail" class="hidden"></div>
        </div>

        <div id="page-prof" class="page">
            <div style="text-align:center; padding:30px;">
                <img id="p-img" class="list-img" style="width:90px; height:90px; border:2px solid var(--blue);">
                <h2 id="p-name" style="margin:10px 0;"></h2>
                <div id="my-prof-actions" class="hidden">
                    <button onclick="document.getElementById('st-up').click()" style="background:var(--grad);">üì∏ Hikaye Ekle</button>
                    <input type="file" id="st-up" class="hidden" onchange="uploadStory(this)">
                    <button onclick="logout()" style="background:#1a1a1a; margin-top:10px;">√áƒ±kƒ±≈ü Yap</button>
                </div>
                <div id="other-prof-actions" class="hidden">
                    <button id="f-btn" onclick="handleFollow()">Takip Et</button>
                </div>
            </div>
        </div>
    </div>

    <div class="nav">
        <div class="nav-i active" onclick="nav('home', this)">üè†</div>
        <div class="nav-i" onclick="nav('search', this)">üîç</div>
        <div class="nav-i" onclick="nav('add', this)">‚ûï</div>
        <div class="nav-i" onclick="nav('msg', this)">üí¨</div>
        <div class="nav-i" onclick="nav('prof', this, true)">üë§</div>
    </div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyAFcxbgumt1FFDqZAYGbYWAaLyplMB6yM4", authDomain: "notsakla-a165c.firebaseapp.com", databaseURL: "https://notsakla-a165c-default-rtdb.firebaseio.com", projectId: "notsakla-a165c", storageBucket: "notsakla-a165c.firebasestorage.app", appId: "1:374348253046:web:cb9b66993d80f682911c57" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let cur = null, viewU = null, activeChat = null, activeStory = null;

    window.onload = () => {
        const saved = localStorage.getItem('notUser');
        if(saved) db.ref('users/'+saved).once('value', sn => { if(sn.exists()){ cur = sn.val(); startApp(); } });
    };

    function startApp() {
        document.getElementById('app').classList.remove('hidden');
        if(cur.role == 'admin') loadAdminList();
        loadFeed(); loadStories(); doSearch(""); loadChatList();
    }

    // STORY LOGIC (KAR≈ûILIKLI TAKƒ∞P)
    function loadStories() {
        db.ref('stories').on('value', sn => {
            const stories = sn.val() || {}; let h = "";
            for(let u in stories) {
                // Gizlilik: Sen onu takip ediyorsan VE o seni takip ediyorsa g√∂r
                db.ref('users/'+u).once('value', usn => {
                    const ud = usn.val();
                    const iFollow = ud.followers && ud.followers[cur.user];
                    const heFollows = cur.following && cur.following[u];
                    
                    if(iFollow && heFollows || u == cur.user) {
                        h += `<div class="story-ring" onclick="viewStory('${u}')"><img src="${ud.img}" class="story-img"></div>`;
                        document.getElementById('home-stories').innerHTML = h;
                    }
                });
            }
        });
    }

    function viewStory(u) {
        activeStory = u;
        db.ref('stories/'+u).once('value', sn => {
            const s = sn.val();
            document.getElementById('story-overlay').style.display = 'flex';
            document.getElementById('st-img-full').src = s.img;
            document.getElementById('st-user-info').innerHTML = `<img src="${s.ownerImg}" class="list-img" style="width:30px;height:30px;"> <b>${u}</b>`;
            
            // G√∂r√ºld√º ƒ∞≈ülemi
            if(u !== cur.user) db.ref('stories/'+u+'/viewers/'+cur.user).set(true);
            
            // ƒ∞zleyici Sayƒ±sƒ±
            const views = s.viewers ? Object.keys(s.viewers).length : 0;
            document.getElementById('st-views').innerText = views + " ki≈üi g√∂rd√º";
        });
    }

    function showWhoViewed() {
        db.ref('stories/'+activeStory+'/viewers').once('value', sn => {
            alert("G√∂renler: " + Object.keys(sn.val() || {}).join(", "));
        });
    }

    // ADMIN FULL YETKƒ∞
    function loadAdminList() {
        db.ref('users').on('value', sn => {
            const us = sn.val(); let h = "<h3>Y√∂netim</h3>";
            for(let u in us) h += `<div class="list-item" onclick="manageTitan('${u}')"><img src="${us[u].img}" class="list-img"><div class="list-info"><div class="list-name">${u}</div></div></div>`;
            document.getElementById('ad-list').innerHTML = h;
        });
    }

    function manageTitan(u) {
        db.ref('users/'+u).once('value', sn => {
            const d = sn.val();
            document.getElementById('ad-detail').classList.remove('hidden');
            document.getElementById('ad-detail').innerHTML = `
                <div class="adm-card">
                    <h3>${u}</h3>
                    <p style="font-size:12px;opacity:0.6;">Pass: ${d.pass} | Mail: ${d.mail}</p>
                    <div class="adm-grid">
                        <button class="adm-btn" onclick="admOp('${u}','user')">Ad Deƒüi≈ütir</button>
                        <button class="adm-btn" onclick="admOp('${u}','pass')">≈ûifre Deƒüi≈ütir</button>
                        <button class="adm-btn" onclick="admOp('${u}','fakeFollowers')">Fake Takip√ßi</button>
                        <button class="adm-btn" style="background:var(--red)" onclick="db.ref('users/${u}/banned').set(true)">BANLA</button>
                        <button class="adm-btn" style="background:var(--blue)" onclick="db.ref('users/${u}/verified').set(true)">Mavi Tƒ±k Ver</button>
                        <button class="adm-btn" style="background:grey" onclick="db.ref('users/${u}/verified').set(false)">Mavi Tƒ±k Al</button>
                        <button class="adm-btn" style="background:purple" onclick="viewPrivate('${u}')">Gizli Postlar</button>
                        <button class="adm-btn" style="background:red" onclick="db.ref('users/${u}').remove()">TAMAMEN Sƒ∞L</button>
                    </div>
                </div>`;
        });
    }

    // MESAJLAR (RESƒ∞MDEKƒ∞ Lƒ∞STE TASARIMI)
    function loadChatList() {
        db.ref('chats').on('value', sn => {
            const chats = sn.val() || {}; let h = "";
            const targets = Object.keys(chats).filter(id => id.includes(cur.user));
            targets.forEach(cid => {
                const other = cid.replace(cur.user,'').replace('_','');
                db.ref('users/'+other).once('value', usn => {
                    const ud = usn.val();
                    h += `<div class="list-item" onclick="openActiveChat('${other}')">
                            <img src="${ud.img}" class="list-img">
                            <div class="list-info">
                                <div class="list-name">${other}</div>
                                <div class="list-sub">Sohbeti a√ßmak i√ßin dokun</div>
                            </div>
                          </div>`;
                    document.getElementById('chat-list').innerHTML = h;
                });
            });
        });
    }

    function openActiveChat(other) {
        activeChat = [cur.user, other].sort().join('_');
        document.getElementById('chat-list').classList.add('hidden');
        document.getElementById('chat-box').classList.remove('hidden');
        document.getElementById('chat-target-name').innerText = other;
        db.ref('chats/'+activeChat).on('value', sn => {
            const ms = sn.val() || {}; let h = "";
            Object.keys(ms).forEach(mid => {
                const m = ms[mid]; const isMe = m.u === cur.user;
                if(!isMe && !m.seen) db.ref('chats/'+activeChat+'/'+mid+'/seen').set(true);
                const tƒ±k = isMe ? (m.seen ? '<span style="color:var(--blue)">‚úì‚úì</span>' : '‚úì') : '';
                h += `<div style="text-align:${isMe?'right':'left'};margin-bottom:10px;">
                        <div style="display:inline-block;padding:10px 15px;border-radius:18px;background:${isMe?var(--blue):'#262626'};font-size:14px;">${m.m} ${tƒ±k}</div>
                      </div>`;
            });
            document.getElementById('chat-messages').innerHTML = h;
        });
    }

    // BASE
    function nav(id, el, isMy) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-'+id).classList.add('active');
        document.querySelectorAll('.nav-i').forEach(i => i.classList.remove('active'));
        if(el) el.classList.add('active');
        if(isMy) viewProfile(cur.user);
    }
    function closeStory() { document.getElementById('story-overlay').style.display='none'; }
    function closeChat() { document.getElementById('chat-box').classList.add('hidden'); document.getElementById('chat-list').classList.remove('hidden'); }
    function sendMsg() { const i = document.getElementById('msg-input'); if(i.value) db.ref('chats/'+activeChat).push({u:cur.user, m:i.value, t:Date.now(), seen:false}); i.value=""; }
    function admOp(u,k) { const v = prompt("Yeni:"); if(v) db.ref('users/'+u+'/'+k).set(v); }
    function viewProfile(u) { viewU = u; nav('prof'); db.ref('users/'+u).on('value', sn => { const d = sn.val(); document.getElementById('p-name').innerText = u; document.getElementById('p-img').src = d.img; if(u==cur.user) document.getElementById('my-prof-actions').classList.remove('hidden'); else document.getElementById('other-prof-actions').classList.remove('hidden'); }); }
</script>
</body>
</html>
